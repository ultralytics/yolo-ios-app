# Ultralytics üöÄ AGPL-3.0 License - https://ultralytics.com/license

# Publish YOLO iOS app to TestFlight and create release

name: Publish iOS App

on:
  push:
    branches: [main]
  pull_request:
    types: [opened]
    branches: [main]
  workflow_dispatch:
    inputs:
      source_branch:
        description: "Branch to publish"
        required: true
        default: "main"
        type: string
      release:
        description: "Create new tag and release"
        required: true
        type: boolean
        default: false
      testflight:
        description: "Publish to TestFlight"
        required: true
        type: boolean
        default: true

jobs:
  check:
    if: github.repository == 'ultralytics/yolo-ios-app' && (github.actor == 'glenn-jocher' || github.actor == 'asabri97' || github.actor == 'john-rocky')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new_version: ${{ steps.check_version.outputs.new_version }}
      current_tag: ${{ steps.check_version.outputs.current_tag }}
      marketing_version: ${{ steps.check_version.outputs.marketing_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets._GITHUB_TOKEN }}
          ref: ${{ inputs.source_branch || 'main' }}
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - uses: astral-sh/setup-uv@v6
        with:
          enable-cache: false
      - run: uv pip install --system --no-cache ultralytics-actions
      - id: check_version
        shell: python
        run: |
          import os, re

          # Read MARKETING_VERSION from project.pbxproj
          with open('YOLOiOSApp/YOLOiOSApp.xcodeproj/project.pbxproj', 'r') as f:
              content = f.read()

          version_match = re.search(r'MARKETING_VERSION = ([^;]+);', content)
          if not version_match:
              raise ValueError("MARKETING_VERSION not found in project.pbxproj")

          marketing_version = version_match.group(1).strip()
          current_tag = f'v{marketing_version}'

          # Check if tag already exists
          tag_exists = os.system(f'git rev-parse {current_tag} >/dev/null 2>&1') == 0
          new_version = not tag_exists

          os.system(f'echo "new_version={str(new_version).lower()}" >> $GITHUB_OUTPUT')
          os.system(f'echo "current_tag={current_tag}" >> $GITHUB_OUTPUT')
          os.system(f'echo "marketing_version={marketing_version}" >> $GITHUB_OUTPUT')

          if new_version:
              print(f'New marketing version {current_tag} detected ‚úÖ')
          else:
              print(f'Marketing version {current_tag} unchanged - TestFlight will use incremented build number')

  release:
    needs: check
    if: needs.check.outputs.new_version == 'true' && (github.event_name == 'push' || inputs.release == true)
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets._GITHUB_TOKEN }}
          ref: ${{ inputs.source_branch || 'main' }}
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - uses: astral-sh/setup-uv@v6
        with:
          enable-cache: false
      - run: uv pip install --system --no-cache ultralytics-actions
      - name: Create tag and release
        env:
          GITHUB_TOKEN: ${{ secrets._GITHUB_TOKEN }}
          CURRENT_TAG: ${{ needs.check.outputs.current_tag }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          git config --global user.name "UltralyticsAssistant"
          git config --global user.email "web@ultralytics.com"
          git tag -a "$CURRENT_TAG" -m "$(git log -1 --pretty=%B)"
          git push origin "$CURRENT_TAG"
          ultralytics-actions-summarize-release
          uv cache prune --ci

  testflight:
    needs: check
    if: github.event_name == 'pull_request' || inputs.testflight == true
    runs-on: macos-26
    permissions:
      contents: write
    environment:
      name: Release - TestFlight
      url: https://appstoreconnect.apple.com/apps
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || inputs.source_branch || 'main' }}

      - name: Setup Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      - name: Prepare testflight branch (single commit)
        run: |
          git config user.name "UltralyticsAssistant"
          git config user.email "web@ultralytics.com"
          git fetch origin

          # Create testflight branch from source
          SOURCE_BRANCH="${{ github.event_name == 'pull_request' && github.head_ref || inputs.source_branch || 'main' }}"
          git checkout -B testflight origin/$SOURCE_BRANCH

          # Squash all commits into one
          FIRST_COMMIT=$(git rev-list --max-parents=0 HEAD)
          git reset --soft $FIRST_COMMIT

          # Resolve dependencies and add to commit
          cd YOLOiOSApp
          xcodebuild -resolvePackageDependencies -project YOLOiOSApp.xcodeproj -scheme YOLOiOSApp
          cd ..
          git add -f YOLOiOSApp/YOLOiOSApp.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved

          # Single commit with version info
          MARKETING_VERSION="${{ needs.check.outputs.marketing_version }}"
          CURRENT_BUILD=$(/usr/libexec/PlistBuddy -c "Print CFBundleVersion" "YOLOiOSApp/YOLOiOSApp/Info.plist")
          git commit -m "v$MARKETING_VERSION ($CURRENT_BUILD)"

      - name: Push to Xcode Cloud
        run: git push --force origin testflight

  notify:
    needs: [check, release, testflight]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Extract PR Details
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_JSON=$(gh pr list --search "${GITHUB_SHA}" --state merged --json number,title --jq '.[0]')
          PR_NUMBER=$(echo "${PR_JSON}" | jq -r '.number')
          PR_TITLE=$(echo "${PR_JSON}" | jq -r '.title' | sed 's/"/\\"/g')
          echo "PR_NUMBER=${PR_NUMBER}" >> "${GITHUB_ENV}"
          echo "PR_TITLE=${PR_TITLE}" >> "${GITHUB_ENV}"
      - name: Notify Success
        if: (needs.release.result == 'success' && github.event_name == 'push') || (needs.testflight.result == 'success' && github.event_name == 'pull_request')
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook-type: incoming-webhook
          webhook: ${{ secrets.SLACK_WEBHOOK_URL_HUBWEB }}
          payload: |
            text: "<!channel> GitHub Actions success for ${{ github.workflow }} ‚úÖ\n\n\n*Repository:* https://github.com/${{ github.repository }}\n*Action:* https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n*Author:* ${{ github.actor }}\n*Event:* ${{ github.event_name == 'push' && format('NEW `YOLO iOS {0}` release published üéâ', needs.check.outputs.current_tag) || 'TestFlight build triggered for PR üöÄ' }}\n*Job Status:* ${{ job.status }}\n*Pull Request:* <https://github.com/${{ github.repository }}/pull/${{ env.PR_NUMBER }}> ${{ env.PR_TITLE }}\n${{ github.event_name == 'push' && format('*Release Notes:* https://github.com/{0}/releases/tag/{1}', github.repository, needs.check.outputs.current_tag) || '' }}\n"
      - name: Notify Failure
        if: (needs.release.result != 'success' && github.event_name == 'push') || (needs.testflight.result != 'success' && github.event_name == 'pull_request')
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook-type: incoming-webhook
          webhook: ${{ secrets.SLACK_WEBHOOK_URL_HUBWEB }}
          payload: |
            text: "<!channel> GitHub Actions error for ${{ github.workflow }} ‚ùå\n\n\n*Repository:* https://github.com/${{ github.repository }}\n*Action:* https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n*Author:* ${{ github.actor }}\n*Event:* ${{ github.event_name == 'push' && 'Release failed' || 'TestFlight build failed for PR' }}\n*Job Status:* ${{ job.status }}\n*Pull Request:* <https://github.com/${{ github.repository }}/pull/${{ env.PR_NUMBER }}> ${{ env.PR_TITLE }}\n"

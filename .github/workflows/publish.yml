# Ultralytics ðŸš€ AGPL-3.0 License - https://ultralytics.com/license

# This workflow publishes the YOLO iOS app to TestFlight and/or submits to App Store

name: Publish iOS App

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Branch to merge into testflight'
        required: true
        default: 'main'
        type: string
      deploy_testflight:
        description: 'Deploy to TestFlight'
        required: true
        default: false
        type: boolean
      force_push:
        description: 'Force push to testflight (for testing)'
        required: false
        default: false
        type: boolean
      deploy_appstore:
        description: 'Submit to App Store'
        required: true
        default: false
        type: boolean

permissions:
  contents: write # Push to testflight branch

jobs:
  testflight: # Deploy to TestFlight by merging to testflight branch
    if: inputs.deploy_testflight
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      - name: Merge to testflight branch
        run: |
          git config user.name "UltralyticsAssistant"
          git config user.email "web@ultralytics.com"
          git checkout testflight
          git merge origin/${{ inputs.source_branch }} --no-ff -m "Merge ${{ inputs.source_branch }} into testflight for TestFlight deployment"

      - name: Auto-increment build number
        run: |
          INFO_PLIST="YOLOiOSApp/YOLOiOSApp/Info.plist"
          CURRENT_BUILD=$(/usr/libexec/PlistBuddy -c "Print CFBundleVersion" "$INFO_PLIST")
          NEW_BUILD=$((CURRENT_BUILD + 1))
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $NEW_BUILD" "$INFO_PLIST"
          echo "Build number incremented: $CURRENT_BUILD â†’ $NEW_BUILD"
          git add "$INFO_PLIST"
          git commit -m "Increment build number to $NEW_BUILD for TestFlight"

      - name: Resolve Package Dependencies and Commit
        run: |
          cd YOLOiOSApp
          xcodebuild -resolvePackageDependencies -project YOLOiOSApp.xcodeproj -scheme YOLOiOSApp
          cd ..
          git add -f YOLOiOSApp/YOLOiOSApp.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved
          git commit -m "Update Package.resolved for TestFlight build" || echo "No Package.resolved changes"

      - name: Force commit if requested
        if: inputs.force_push
        run: |
          echo "Force push requested - creating empty commit to trigger TestFlight build"
          git commit --allow-empty -m "Force TestFlight build (triggered manually)"

      - name: Push to testflight
        run: |
          git push origin testflight

  appstore: # Submit to App Store for review
    if: inputs.deploy_appstore && github.repository == 'ultralytics/yolo-ios-app' && (github.actor == 'glenn-jocher' || github.actor == 'asabri97' || github.actor == 'john-rocky')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Submit to App Store
        run: |
          echo "TODO: Implement App Store submission"
          echo "This would typically involve:"
          echo "- Building the app"
          echo "- Code signing"
          echo "- Uploading to App Store Connect"
          echo "- Submitting for review"
